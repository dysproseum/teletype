<html>
<head>
<title>Teletype | tmodem on COM1</title>
<style type="text/css">
body {
  margin: 0;
}
textarea {
  overflow: hidden;
  border: 1px solid black;
  font-family: monospace;
  resize: none;
  line-break: anywhere;
  margin: 20px;
}
#statusbar {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 20px;
  overflow: hidden;
  background: #eeeeee;
}
</style>
<script type="text/javascript" src="ping.js"></script>
<script type="text/javascript">
var url = '/teletype/post.php';
window.onload = function() {
  var textscreen = document.getElementById("textscreen");
  var statusbar = document.getElementById("message");

  // Pre-fill textarea with chars.
  var buffer = 'Establishing connection ';
  var c = '.';
  var size = 3280;
  for(var i=buffer.length; i < size; i++) {
    buffer += c;
  }
  textscreen.value = buffer;


  textscreen.onkeydown = function(e) {
    console.log(e);
    // Backspace, Delete, Enter.
    if (e.keyCode == 8 || e.keyCode == 46 || e.keyCode == 13) {
      return;
    }
  };

  textscreen.onkeypress = function(e) {
    var key = String.fromCharCode(e.which || e.charCode || e.keyCode);
    if (/[A-Za-z0-9 ]/.test(key)) {
        var text = this.value;
        var caret = getCaret(this);

        var msg = "Input: " + e.key + " position " + caret + " time " + e.timeStamp;
        //statusbar.innerText = msg;

        // Send this back to server (ping.js).
        loadDoc(url + "?letra=" + e.key + "&caret=" + caret + "&stamp=" + e.timeStamp, true);

        var output = text.substring(0, caret);
        this.value = output + key + text.substring(caret + 1);
        setCaretPosition('textscreen', caret + 1);
        return false;
    }
    return false;
  };

  // setTimeout to check for new data.
  var timeout;
  var timeOut = function() {
    timeout = setTimeout(timeOut, 5000);
    loadDoc(url);
  };
  setCaretPosition('textscreen', 0);
  textscreen.focus();
  setTimeout(timeOut, 3000);

}

function getCaret(el) { 
  if (el.selectionStart) { 
    return el.selectionStart; 
  } else if (document.selection) { 
    el.focus(); 

    var r = document.selection.createRange(); 
    if (r == null) { 
      return 0; 
    } 

    var re = el.createTextRange(), 
        rc = re.duplicate(); 
    re.moveToBookmark(r.getBookmark()); 
    rc.setEndPoint('EndToStart', re); 

    return rc.text.length; 
  }  
  return 0; 
}

function setCaretPosition(elemId, caretPos) {
    var elem = document.getElementById(elemId);

    if(elem != null) {
        if(elem.createTextRange) {
            var range = elem.createTextRange();
            range.move('character', caretPos);
            range.select();
        }
        else {
            if(elem.selectionStart) {
                elem.focus();
                elem.setSelectionRange(caretPos, caretPos + 1);
            }
            else
                elem.focus();
        }
    }
}

</script>
<body>
<h1>tmodem on COM1</h1>
<form>
	<label for="baud_rate">Baud rate</label>
		<select name="baud_rate">
			<option value="2400">2400</option>
			<option value="4800">4800</option>
			<option value="9600">9600</option>
			<option value="14400">14400</option>
			<option value="33600">33600</option>
			<option value="57600">57600</option>
			<option value="115200">115200</option>
	</select>
	<input type="button" value="Reconnect" />
</form>
<textarea name="screen" id="textscreen" spellcheck="false" cols="80" rows="40">
</textarea>
<div id="statusbar">Serial connection on COM1 <span id="message"></span></div>
</body>
